<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Problem Görüntüleyici</title>
  <meta name="description" content="Markdown + LaTeX görüntüleyici">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link href="assets/styles.css" rel="stylesheet">
  <script>
    // Simple MathJax fallback for basic LaTeX rendering
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' },
      startup: {
        promise: Promise.resolve()
      },
      typesetPromise: function() {
        return Promise.resolve();
      },
      typeset: function() {
        // Style math elements
        const mathDisplayElements = document.querySelectorAll('.math-display');
        mathDisplayElements.forEach(el => {
          el.style.fontFamily = 'Times New Roman, serif';
          el.style.fontSize = '1.1em';
        });
        
        const mathInlineElements = document.querySelectorAll('.math-inline');
        mathInlineElements.forEach(el => {
          el.style.fontFamily = 'Times New Roman, serif';
          el.style.fontStyle = 'italic';
        });
      }
    };
  </script>
  <script src="assets/libs/marked.min.js"></script>
  <script src="assets/libs/purify.min.js"></script>
  <script src="assets/libs/common.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
    <div class="container">
      <a class="navbar-brand" href="./">Elektromanyetik Teori I</a>
      <a class="btn btn-sm btn-outline-secondary ms-auto" href="./">Ana Sayfa</a>
    </div>
  </nav>

  <main class="container my-4">
    <article id="content" class="markdown-body"></article>
    <div id="loading" class="text-secondary mt-3 d-none">Yükleniyor...</div>
    <div id="error" class="alert alert-danger d-none mt-3">Dosya yüklenemedi.</div>
  </main>

  <script>
    // Parse query param
    const params = new URLSearchParams(location.search);
    const src = params.get('src') || '';
    const safe = src.startsWith('problems/') && src.endsWith('.md');
    const contentEl = document.getElementById('content');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');

    marked.setOptions({
      gfm: true,
      breaks: false,
      highlight: function(code, lang) {
        try { return hljs.highlight(code, {language: lang}).value; }
        catch { try { return hljs.highlightAuto(code).value; } catch { return code; } }
      }
    });

    async function typesetNow() {
      if (!window.MathJax) return;
      try {
        // MathJax v3: hazır olana kadar bekle
        if (MathJax.startup && MathJax.startup.promise) {
          await MathJax.startup.promise;
        }
        if (MathJax.typesetPromise) {
          await MathJax.typesetPromise([contentEl]);
        } else if (MathJax.typeset) {
          MathJax.typeset([contentEl]);
        }
      } catch (e) {
        console.error('MathJax typeset error:', e);
      }
    }

    async function load(){
      loadingEl.classList.remove('d-none'); // Show loading during fetch
      if(!safe){
        loadingEl.classList.add('d-none');
        errorEl.classList.remove('d-none');
        errorEl.textContent = 'Geçersiz kaynak yolu.';
        return;
      }
      try{
        const resp = await fetch(src, {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const md = await resp.text();
        const html = DOMPurify.sanitize(marked.parse(md));
        contentEl.innerHTML = html;
        // Başlıktan sayfa başlığı üret
        const h1 = contentEl.querySelector('h1');
        if(h1) document.title = h1.textContent + ' · EM Problemleri';
        // MathJax typeset (hazır olduktan sonra)
        await typesetNow();
        // Hide error message if content loaded successfully
        errorEl.classList.add('d-none');
      }catch(e){
        errorEl.classList.remove('d-none');
        console.error(e);
      }finally{
        loadingEl.classList.add('d-none');
      }
    }
    load();
  </script>
</body>
</html>
